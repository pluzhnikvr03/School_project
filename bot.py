
import telebot
from telebot import types
token = '8281529454:AAEPnPyn1HwsOzMXuBHo47i6LTFC3wPLTtU'
from database import *  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ database.py

create_database()

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ config.py
bot = telebot.TeleBot(token)

# –°–û–°–¢–û–Ø–ù–ò–Ø –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–º
user_waiting_for_data = {}  # {user_id: True} - –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ –§–ò–û –∏ –∫–ª–∞—Å—Å–∞
user_data_temp = {}  # {user_id: {'fio': '...', 'class': '...'}} - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
user_pending_qr = {}  # {user_id: 'qr_code'} - —Ö—Ä–∞–Ω–∏—Ç QR-–∫–æ–¥, —Å –∫–æ—Ç–æ—Ä—ã–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
user_context = {}  # {user_id: 'action'} - –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–µ–π—Å—Ç–≤–∏—è (take/return)


# –°–æ–∑–¥–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é
def create_main_keyboard():
    """
    –°–æ–∑–¥–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –º–µ–Ω—é
    """
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    buttons = [
        "üìö –ú–æ–∏ –∫–Ω–∏–≥–∏",  # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        "üìñ –í–∑—è—Ç—å –∫–Ω–∏–≥—É",  # –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤–∑—è—Ç–∏—è –∫–Ω–∏–≥–∏
        "üìï –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É",  # –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–Ω–∏–≥–∏
        "‚ÑπÔ∏è –ü–æ–º–æ—â—å",  # –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
        "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å"  # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    ]
    keyboard.add(*buttons)
    return keyboard


# –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –æ—Ç–º–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è
def create_cancel_keyboard():
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ–Ω–∞"
    """
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add("‚ùå –û—Ç–º–µ–Ω–∞")
    return keyboard


# –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
def create_confirmation_keyboard(action, qr_code):
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

    Args:
        action (str): 'take' –¥–ª—è –≤–∑—è—Ç–∏—è, 'return' –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
        qr_code (str): QR-–∫–æ–¥ –∫–Ω–∏–≥–∏ –¥–ª—è callback_data
    """
    keyboard = types.InlineKeyboardMarkup()

    if action == 'take':
        keyboard.row(
            types.InlineKeyboardButton("‚úÖ –î–∞, –≤–∑—è—Ç—å –∫–Ω–∏–≥—É", callback_data=f"confirm_take_{qr_code}"),
            types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_action")
        )
    elif action == 'return':
        keyboard.row(
            types.InlineKeyboardButton("‚úÖ –î–∞, –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É", callback_data=f"confirm_return_{qr_code}"),
            types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_action")
        )

    return keyboard


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========

@bot.message_handler(commands=['start'])
def handle_start(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é
    """
    user_id = message.from_user.id
    first_name = message.from_user.first_name

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–ê–ó–ï –î–ê–ù–ù–´–•
    if is_user_registered(user_id):
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        welcome_text = f"""
üëã *–ü—Ä–∏–≤–µ—Ç, {first_name}!*

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤–∞—à–µ–π —à–∫–æ–ª—ã!

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ:
‚Ä¢ üìö *–ú–æ–∏ –∫–Ω–∏–≥–∏* - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∑—è—Ç—ã–µ –∫–Ω–∏–≥–∏
‚Ä¢ üìñ *–í–∑—è—Ç—å –∫–Ω–∏–≥—É* - –≤–∑—è—Ç—å –Ω–æ–≤—ã–π —É—á–µ–±–Ω–∏–∫
‚Ä¢ üìï *–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É* - –≤–µ—Ä–Ω—É—Ç—å —É—á–µ–±–Ω–∏–∫
‚Ä¢ üë§ *–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å* - –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
‚Ä¢ ‚ÑπÔ∏è *–ü–æ–º–æ—â—å* - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

*–ß—Ç–æ–±—ã –≤–∑—è—Ç—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É:*
1. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞ —É—á–µ–±–Ω–∏–∫–µ
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ
        """

        bot.send_message(
            message.chat.id,
            welcome_text,
            parse_mode='Markdown',
            reply_markup=create_main_keyboard()
        )
    else:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        welcome_text = f"""
üëã *–ü—Ä–∏–≤–µ—Ç, {first_name}!*

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤–∞—à–µ–π —à–∫–æ–ª—ã!

–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.

*–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:*
`–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ –ö–ª–∞—Å—Å`

*–ü—Ä–∏–º–µ—Ä—ã:*
`–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á 10–ê`
`–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ 9–ë`

*–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:*
        """

        user_waiting_for_data[user_id] = True
        bot.send_message(
            message.chat.id,
            welcome_text,
            parse_mode='Markdown',
            reply_markup=types.ReplyKeyboardRemove()  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        )


@bot.message_handler(commands=['help'])
def handle_help(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
    """
    help_text = """
üìö *–ü–û–ú–û–©–¨ –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ –ë–ò–ë–õ–ò–û–¢–ï–ö–ò*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

*–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–Ω–∏–≥–∞–º–∏:*

1. üìñ *–í–ó–Ø–¢–¨ –ö–ù–ò–ì–£:*
   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–í–∑—è—Ç—å –∫–Ω–∏–≥—É" –≤ –º–µ–Ω—é
   ‚Ä¢ –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞ —É—á–µ–±–Ω–∏–∫–µ
   ‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É
   ‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∑—è—Ç–∏–µ

2. üìï *–í–ï–†–ù–£–¢–¨ –ö–ù–ò–ì–£:*
   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É" –≤ –º–µ–Ω—é
   ‚Ä¢ –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞ —É—á–µ–±–Ω–∏–∫–µ
   ‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –±–æ—Ç—É
   ‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç

3. üìö *–ú–û–ò –ö–ù–ò–ì–ò:*
   ‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –±—Ä–∞–ª–∏
   ‚Ä¢ –û—Ç–º–µ—á–∞–µ—Ç, –∫–∞–∫–∏–µ –∫–Ω–∏–≥–∏ —É –≤–∞—Å –Ω–∞ —Ä—É–∫–∞—Ö
   ‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—ã –≤—ã–¥–∞—á–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞

*–í–∞–∂–Ω–æ:*
‚Ä¢ QR-–∫–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –æ–±–ª–æ–∂–∫–µ –∫–∞–∂–¥–æ–≥–æ —É—á–µ–±–Ω–∏–∫–∞
‚Ä¢ –û–¥–∏–Ω QR-–∫–æ–¥ = –æ–¥–∏–Ω —É—á–µ–±–Ω–∏–∫
‚Ä¢ –ù–µ —Ç–µ—Ä—è–π—Ç–µ QR-–∫–æ–¥—ã!
‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –≤–æ–≤—Ä–µ–º—è

*–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã:*
–ï—Å–ª–∏ QR-–∫–æ–¥ –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é.
    """

    bot.send_message(
        message.chat.id,
        help_text,
        parse_mode='Markdown',
        reply_markup=create_main_keyboard()
    )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ú–ï–ù–Æ ==========

@bot.message_handler(func=lambda message: message.text == "üìö –ú–æ–∏ –∫–Ω–∏–≥–∏")
def handle_my_books(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    """
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if not is_user_registered(user_id):
        bot.send_message(
            message.chat.id,
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=create_main_keyboard()
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –∫–Ω–∏–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–ê–ó–´ –î–ê–ù–ù–´–•
    # –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é get_user_books() –≤ database.py
    # books = get_user_books(user_id)

    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    info_text = """
üìö *–í–∞—à–∏ –∫–Ω–∏–≥–∏*

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!

–ü–æ–∫–∞ —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ –í–∑—è—Ç—å –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –º–µ–Ω—é "üìñ –í–∑—è—Ç—å –∫–Ω–∏–≥—É"
‚Ä¢ –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –º–µ–Ω—é "üìï –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É"

*–°–æ–≤–µ—Ç:* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.
    """

    bot.send_message(
        message.chat.id,
        info_text,
        parse_mode='Markdown',
        reply_markup=create_main_keyboard()
    )


@bot.message_handler(func=lambda message: message.text == "üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å")
def handle_profile(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    """
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if not is_user_registered(user_id):
        bot.send_message(
            message.chat.id,
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=create_main_keyboard()
        )
        return

    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ –ë–î
    profile_text = f"""
üë§ *–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å*

*Telegram ID:* `{user_id}`
*–ò–º—è –≤ Telegram:* {message.from_user.first_name}

*–°—Ç–∞—Ç—É—Å:* ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ

*–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –§–ò–û –∏ –∫–ª–∞—Å—Å–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é.*
    """

    bot.send_message(
        message.chat.id,
        profile_text,
        parse_mode='Markdown',
        reply_markup=create_main_keyboard()
    )


@bot.message_handler(func=lambda message: message.text == "üìñ –í–∑—è—Ç—å –∫–Ω–∏–≥—É")
def handle_take_book_menu(message):
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤–∑—è—Ç–∏—è –∫–Ω–∏–≥–∏
    """
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if not is_user_registered(user_id):
        bot.send_message(
            message.chat.id,
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=create_main_keyboard()
        )
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç "–≤–∑—è—Ç—å –∫–Ω–∏–≥—É"
    user_context[user_id] = 'take'

    instruction_text = """
üìñ *–í–ó–Ø–¢–ò–ï –ö–ù–ò–ì–ò*

*–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –ù–∞–π–¥–∏—Ç–µ QR-–∫–æ–¥ –Ω–∞ —É—á–µ–±–Ω–∏–∫–µ (–æ–±—ã—á–Ω–æ –Ω–∞ –æ–±–ª–æ–∂–∫–µ)
2. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –µ–≥–æ –∫–∞–º–µ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥ –º–Ω–µ

*–ö–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:* `MATH-001`

*–ü—Ä–∏–º–µ—Ä QR-–∫–æ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞:* `TEST-001`

*–û—Ç–ø—Ä–∞–≤—å—Ç–µ QR-–∫–æ–¥ –∫–Ω–∏–≥–∏:*
    """

    bot.send_message(
        message.chat.id,
        instruction_text,
        parse_mode='Markdown',
        reply_markup=create_cancel_keyboard()  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ–Ω–∞"
    )


@bot.message_handler(func=lambda message: message.text == "üìï –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É")
def handle_return_book_menu(message):
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–Ω–∏–≥–∏
    """
    user_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if not is_user_registered(user_id):
        bot.send_message(
            message.chat.id,
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=create_main_keyboard()
        )
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç "–≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É"
    user_context[user_id] = 'return'

    instruction_text = """
üìï *–í–û–ó–í–†–ê–¢ –ö–ù–ò–ì–ò*

*–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –ù–∞–π–¥–∏—Ç–µ QR-–∫–æ–¥ –Ω–∞ —É—á–µ–±–Ω–∏–∫–µ (–æ–±—ã—á–Ω–æ –Ω–∞ –æ–±–ª–æ–∂–∫–µ)
2. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –µ–≥–æ –∫–∞–º–µ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥ –º–Ω–µ

*–ö–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:* `MATH-001`

*–ü—Ä–∏–º–µ—Ä QR-–∫–æ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞:* `TEST-001`

*–û—Ç–ø—Ä–∞–≤—å—Ç–µ QR-–∫–æ–¥ –∫–Ω–∏–≥–∏:*
    """

    bot.send_message(
        message.chat.id,
        instruction_text,
        parse_mode='Markdown',
        reply_markup=create_cancel_keyboard()  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–º–µ–Ω–∞"
    )


@bot.message_handler(func=lambda message: message.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
def handle_help_menu(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ –º–µ–Ω—é
    """
    handle_help(message)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, —á—Ç–æ –∏ –¥–ª—è /help


@bot.message_handler(func=lambda message: message.text == "‚ùå –û—Ç–º–µ–Ω–∞")
def handle_cancel(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–º–µ–Ω–∞"
    """
    user_id = message.from_user.id

    # –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id in user_waiting_for_data:
        del user_waiting_for_data[user_id]
    if user_id in user_data_temp:
        del user_data_temp[user_id]
    if user_id in user_pending_qr:
        del user_pending_qr[user_id]
    if user_id in user_context:
        del user_context[user_id]

    cancel_text = """
‚ùå *–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ*

–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ.
    """

    bot.send_message(
        message.chat.id,
        cancel_text,
        parse_mode='Markdown',
        reply_markup=create_main_keyboard()
    )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ==========

@bot.message_handler(func=lambda message: user_waiting_for_data.get(message.from_user.id, False))
def handle_registration_data(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    """
    user_id = message.from_user.id
    text = message.text.strip()

    # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
    parts = text.split()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ –º–∏–Ω–∏–º—É–º 4 —Å–ª–æ–≤–∞ (–§–ò–û + –∫–ª–∞—Å—Å)
    if len(parts) < 4:
        error_text = """
‚ùå *–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö!*

–í–≤–µ–¥–∏—Ç–µ: *–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ –ö–ª–∞—Å—Å*

*–ü—Ä–∏–º–µ—Ä—ã:*
`–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á 10–ê`
`–ü–µ—Ç—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞ 9–ë`

*–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:*
        """

        bot.send_message(
            message.chat.id,
            error_text,
            parse_mode='Markdown'
        )
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –§–ò–û (–ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ —Å–ª–æ–≤–∞)
    fio = ' '.join(parts[:3])
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª–∞—Å—Å (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞)
    user_class = ' '.join(parts[3:])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_data_temp[user_id] = {
        'fio': fio,
        'class': user_class
    }

    # –£–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    del user_waiting_for_data[user_id]

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–ê–ó–ï –î–ê–ù–ù–´–•
    if register_user(user_id, fio, user_class):
        success_text = f"""
‚úÖ *–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!*

*–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:*
üë§ *–§–ò–û:* {fio}
üè´ *–ö–ª–∞—Å—Å:* {user_class}

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π!

*–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:*
‚Ä¢ üìñ *–í–∑—è—Ç—å –∫–Ω–∏–≥—É* - –ø–æ–ª—É—á–∏—Ç—å —É—á–µ–±–Ω–∏–∫
‚Ä¢ üìï *–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É* - —Å–¥–∞—Ç—å —É—á–µ–±–Ω–∏–∫
‚Ä¢ üìö *–ú–æ–∏ –∫–Ω–∏–≥–∏* - –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è
‚Ä¢ üë§ *–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å* - –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ üëá
        """

        bot.send_message(
            message.chat.id,
            success_text,
            parse_mode='Markdown',
            reply_markup=create_main_keyboard()
        )

        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if user_id in user_data_temp:
            del user_data_temp[user_id]
    else:
        # –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        error_text = """
‚ùå *–û–®–ò–ë–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò*

–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é.
        """

        bot.send_message(
            message.chat.id,
            error_text,
            parse_mode='Markdown',
            reply_markup=create_main_keyboard()
        )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö QR-–ö–û–î–û–í ==========

@bot.message_handler(func=lambda message: message.from_user.id in user_context)
def handle_qr_code_input(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ QR-–∫–æ–¥–∞ –¥–ª—è –≤–∑—è—Ç–∏—è/–≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–Ω–∏–≥–∏
    """
    user_id = message.from_user.id
    qr_code = message.text.strip()
    action = user_context.get(user_id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω –Ω–µ–ø—É—Å—Ç–æ–π –∫–æ–¥
    if not qr_code:
        bot.send_message(
            message.chat.id,
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ QR-–∫–æ–¥ –∫–Ω–∏–≥–∏.",
            reply_markup=create_cancel_keyboard()
        )
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º QR-–∫–æ–¥
    user_pending_qr[user_id] = qr_code

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –∏–∑ –ë–ê–ó–´ –î–ê–ù–ù–´–•
    book_info = get_book_info(qr_code)

    if not book_info:
        # –ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ
        error_text = f"""
‚ùå *–ö–ù–ò–ì–ê –ù–ï –ù–ê–ô–î–ï–ù–ê*

–ö–Ω–∏–≥–∞ —Å –∫–æ–¥–æ–º `{qr_code}` –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.

*–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*
‚Ä¢ –í—ã –æ—à–∏–±–ª–∏—Å—å –ø—Ä–∏ –≤–≤–æ–¥–µ –∫–æ–¥–∞
‚Ä¢ QR-–∫–æ–¥ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
‚Ä¢ –ö–Ω–∏–≥–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É

*–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:*
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞
2. –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –µ—â–µ —Ä–∞–∑
3. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é
        """

        bot.send_message(
            message.chat.id,
            error_text,
            parse_mode='Markdown',
            reply_markup=create_cancel_keyboard()
        )
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ
    book_text = f"""
üìñ *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–ù–ò–ì–ï*

*–ö–æ–¥:* `{book_info['qr_code']}`
*–ù–∞–∑–≤–∞–Ω–∏–µ:* {book_info['subject']}
*–ê–≤—Ç–æ—Ä:* {book_info['author']}
*–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è:* {book_info['year']}
    """

    if action == 'take':
        # –ü–†–û–¶–ï–°–° –í–ó–Ø–¢–ò–Ø –ö–ù–ò–ì–ò

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –∫–Ω–∏–≥–∞
        if not is_book_available(qr_code):
            # –ö–Ω–∏–≥–∞ —É–∂–µ –≤–∑—è—Ç–∞
            book_text += "\n\n‚ùå *–ö–ù–ò–ì–ê –£–ñ–ï –í–ó–Ø–¢–ê*\n\n–≠—Ç–∞ –∫–Ω–∏–≥–∞ —Å–µ–π—á–∞—Å —É –¥—Ä—É–≥–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è."

            bot.send_message(
                message.chat.id,
                book_text,
                parse_mode='Markdown',
                reply_markup=create_cancel_keyboard()
            )
            return

        # –ö–Ω–∏–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–∑—è—Ç—å
        book_text += f"""

‚úÖ *–ö–ù–ò–ì–ê –î–û–°–¢–£–ü–ù–ê*

–•–æ—Ç–∏—Ç–µ –≤–∑—è—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?"""

        bot.send_message(
            message.chat.id,
            book_text,
            parse_mode='Markdown',
            reply_markup=create_confirmation_keyboard('take', qr_code)
        )

    elif action == 'return':
        # –ü–†–û–¶–ï–°–° –í–û–ó–í–†–ê–¢–ê –ö–ù–ò–ì–ò

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–Ω–∏–≥–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if not user_has_book(user_id, qr_code):
            # –ö–Ω–∏–≥–∞ –Ω–µ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            book_text += f"""

‚ùå *–ö–ù–ò–ì–ê –ù–ï –ß–ò–°–õ–ò–¢–°–Ø –ó–ê –í–ê–ú–ò*

–í—ã –Ω–µ –±—Ä–∞–ª–∏ —ç—Ç—É –∫–Ω–∏–≥—É –∏–ª–∏ —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –µ—ë."""

            bot.send_message(
                message.chat.id,
                book_text,
                parse_mode='Markdown',
                reply_markup=create_cancel_keyboard()
            )
            return

        # –ö–Ω–∏–≥–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–µ—Ä–Ω—É—Ç—å
        book_text += f"""

üìö *–ö–ù–ò–ì–ê –£ –í–ê–° –ù–ê –†–£–ö–ê–•*

–•–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?"""

        bot.send_message(
            message.chat.id,
            book_text,
            parse_mode='Markdown',
            reply_markup=create_confirmation_keyboard('return', qr_code)
        )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò INLINE-–ö–ù–û–ü–û–ö ==========

@bot.callback_query_handler(func=lambda call: True)
def handle_inline_buttons(call):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ inline-–∫–Ω–æ–ø–∫–∏
    """
    user_id = call.from_user.id
    callback_data = call.data

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback (—É–±–∏—Ä–∞–µ—Ç "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ)
    bot.answer_callback_query(call.id)

    if callback_data == "cancel_action":
        # –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
        bot.edit_message_text(
            "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            call.message.chat.id,
            call.message.message_id
        )

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if user_id in user_context:
            del user_context[user_id]
        if user_id in user_pending_qr:
            del user_pending_qr[user_id]

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        bot.send_message(
            call.message.chat.id,
            "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
            reply_markup=create_main_keyboard()
        )
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∑—è—Ç–∏—è –∫–Ω–∏–≥–∏
    if callback_data.startswith("confirm_take_"):
        qr_code = callback_data.replace("confirm_take_", "")

        # –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –ë–ê–ó–£ –î–ê–ù–ù–´–•
        if take_book(user_id, qr_code):
            success_text = f"""
‚úÖ *–ö–ù–ò–ì–ê –£–°–ü–ï–®–ù–û –í–´–î–ê–ù–ê!*

*–ö–æ–¥ –∫–Ω–∏–≥–∏:* `{qr_code}`
*–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:* —Å–µ–≥–æ–¥–Ω—è

*–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!*

–í—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ –í–µ—Ä–Ω—É—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –º–µ–Ω—é "üìï –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É"
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –∫–Ω–∏–≥–∏ —á–µ—Ä–µ–∑ "üìö –ú–æ–∏ –∫–Ω–∏–≥–∏"
‚Ä¢ –í–∑—è—Ç—å –µ—â–µ –∫–Ω–∏–≥–∏ —á–µ—Ä–µ–∑ "üìñ –í–∑—è—Ç—å –∫–Ω–∏–≥—É"
            """

            bot.edit_message_text(
                success_text,
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )
        else:
            # –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∫–Ω–∏–≥–∏
            error_text = f"""
‚ùå *–ù–ï –£–î–ê–õ–û–°–¨ –í–ó–Ø–¢–¨ –ö–ù–ò–ì–£*

–ö–Ω–∏–≥–∞ —Å –∫–æ–¥–æ–º `{qr_code}` –Ω–µ –±—ã–ª–∞ –≤—ã–¥–∞–Ω–∞.

*–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*
‚Ä¢ –ö–Ω–∏–≥—É —É–∂–µ –≤–∑—è–ª –¥—Ä—É–≥–æ–π —á–∏—Ç–∞—Ç–µ–ª—å
‚Ä¢ –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
‚Ä¢ –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –≤–∑—è—Ç—ã—Ö –∫–Ω–∏–≥

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é.
            """

            bot.edit_message_text(
                error_text,
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if user_id in user_context:
            del user_context[user_id]
        if user_id in user_pending_qr:
            del user_pending_qr[user_id]

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        bot.send_message(
            call.message.chat.id,
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=create_main_keyboard()
        )

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–Ω–∏–≥–∏
    elif callback_data.startswith("confirm_return_"):
        qr_code = callback_data.replace("confirm_return_", "")

        # –ü—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É —á–µ—Ä–µ–∑ –ë–ê–ó–£ –î–ê–ù–ù–´–•
        if return_book(user_id, qr_code):
            success_text = f"""
‚úÖ *–ö–ù–ò–ì–ê –£–°–ü–ï–®–ù–û –í–û–ó–í–†–ê–©–ï–ù–ê!*

*–ö–æ–¥ –∫–Ω–∏–≥–∏:* `{qr_code}`
*–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞:* —Å–µ–≥–æ–¥–Ω—è

*–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å!*

–ö–Ω–∏–≥–∞ —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —á–∏—Ç–∞—Ç–µ–ª–µ–π.
            """

            bot.edit_message_text(
                success_text,
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )
        else:
            # –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫–Ω–∏–≥–∏
            error_text = f"""
‚ùå *–ù–ï –£–î–ê–õ–û–°–¨ –í–ï–†–ù–£–¢–¨ –ö–ù–ò–ì–£*

–ö–Ω–∏–≥–∞ —Å –∫–æ–¥–æ–º `{qr_code}` –Ω–µ –±—ã–ª–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞.

*–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:*
‚Ä¢ –ö–Ω–∏–≥–∞ —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞
‚Ä¢ –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
‚Ä¢ –ö–Ω–∏–≥–∞ –Ω–µ —á–∏—Å–ª–∏—Ç—Å—è –∑–∞ –≤–∞–º–∏

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä—é.
            """

            bot.edit_message_text(
                error_text,
                call.message.chat.id,
                call.message.message_id,
                parse_mode='Markdown'
            )

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if user_id in user_context:
            del user_context[user_id]
        if user_id in user_pending_qr:
            del user_pending_qr[user_id]

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        bot.send_message(
            call.message.chat.id,
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=create_main_keyboard()
        )


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö –í–°–ï–• –û–°–¢–ê–õ–¨–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô ==========

@bot.message_handler(func=lambda message: True)
def handle_other_messages(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    """
    user_id = message.from_user.id

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–∞–∫–æ–≥–æ-—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è
    if is_user_registered(user_id) and user_id not in user_context:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        help_text = f"""
ü§î *–Ø –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ*

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–Ω–∏–≥–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∏–∂–µ.

*–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üìñ –í–∑—è—Ç—å –∫–Ω–∏–≥—É" —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —É—á–µ–±–Ω–∏–∫
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üìï –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É" —á—Ç–æ–±—ã —Å–¥–∞—Ç—å —É—á–µ–±–Ω–∏–∫
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üìö –ú–æ–∏ –∫–Ω–∏–≥–∏" —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "‚ÑπÔ∏è –ü–æ–º–æ—â—å" –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - —Å–ø—Ä–∞–≤–∫–∞
        """

        bot.send_message(
            message.chat.id,
            help_text,
            parse_mode='Markdown',
            reply_markup=create_main_keyboard()
        )
    elif not is_user_registered(user_id):
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        bot.send_message(
            message.chat.id,
            "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
            reply_markup=types.ReplyKeyboardRemove()
        )


# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

if __name__ == "__main__":
    print("=" * 50)
    print("ü§ñ –ë–ò–ë–õ–ò–û–¢–ï–ß–ù–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù")
    print("=" * 50)
    print("–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print("=" * 50)

    try:
        bot.infinity_polling(timeout=60, long_polling_timeout=60)
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞: {e}")
